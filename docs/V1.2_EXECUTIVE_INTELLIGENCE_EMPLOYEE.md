# v1.2 – Executive Intelligence Layer (Employee Sales Mode)

Reference for existing implementation. Asia/Riyadh, week starts Saturday. No schema changes beyond what already exists.

---

## TASK 1: Targets implementation (discovery)

### A) Boutique monthly target

| Item | Value |
|------|--------|
| **Model** | `BoutiqueMonthlyTarget` |
| **Table** | Same (Prisma) |
| **Key fields** | `month` (String, "YYYY-MM"), `amount` (Int, SAR), `createdById`, `createdAt`, `updatedAt` |
| **Unique** | `@@unique([month])` |

### B) Employee monthly target (per user, per month)

| Item | Value |
|------|--------|
| **Model** | `EmployeeMonthlyTarget` |
| **Table** | Same (Prisma) |
| **Key fields** | `month` (String, "YYYY-MM"), `userId`, `amount` (Int, SAR), plus generation snapshot fields |
| **Unique** | `@@unique([month, userId])` |

### Sales data (for sales aggregation)

| Item | Value |
|------|--------|
| **Model** | `SalesEntry`; employee-level from **BoutiqueSalesLine** (Daily Sales Ledger) |
| **Key fields** | `date`, `month` (YYYY-MM), `userId` / `employeeId`, `amount` / `amountSar` (Int, SAR) |

### Existing target UI/API (unchanged)

- **Admin targets:** `app/(dashboard)/admin/targets/`, `app/api/admin/targets/route.ts`, `app/api/admin/employee-target/route.ts`, `app/api/admin/boutique-target/route.ts`
- **Me target:** `app/(dashboard)/me/target/`, `app/api/me/targets/route.ts`

---

## TASK 2: Executive Intelligence (Employee mode)

### API

- **Route:** `GET /api/executive/employee-intelligence?weekStart=YYYY-MM-DD`
- **Auth:** ADMIN + MANAGER only
- **File:** `app/api/executive/employee-intelligence/route.ts`

### Response (per employee, sorted by ERS desc)

- `revenueWTD`, `revenueMTD` (from BoutiqueSalesLine / SalesEntry)
- `employeeMonthlyTarget` (from `EmployeeMonthlyTarget.amount`)
- `achievementPercent` = MTD / target (percentage)
- `trend`: `uptrend` | `flat` | `downtrend` (3-week sales)
- `consistency`: 0–100 (variance over last 3 weeks)
- `ersScore`, `ersLabel`, `reasons` (sales-centric, explainable)

### Server logic

- **Metrics:** `lib/executive/metrics.ts`
  - `getRevenueTrendDirection(last3WeeksRevenue)`
  - `weeklyRevenueConsistencyScore(weeklyRevenues[])`
  - `computeEmployeeRevenueScore(metrics)` → `{ score, label, reasons }`
- **ERS:** 0–100, higher = better. Labels: Dominant | Strong | Watch | At Risk | Critical. Weights: Achievement 55%, Trend 15%, Consistency 30%.

---

## TASK 3: Governance

### Audit

- **No new table.** Existing `SalesTargetAudit` is used (`monthKey`, `action`, `actorUserId`, `detailsJson`).
- **Employee target changes:** `app/api/admin/employee-target/route.ts` calls `logSalesTargetAudit(month, 'OVERRIDE_EMPLOYEE', user.id, { employeeMonthlyTargetId, userId, oldAmount, newAmount, reason? })`.

### Locking (after day 3)

- **File:** `app/api/admin/employee-target/route.ts`
- **Rule:** After day 3 of the target month (Riyadh), only **ADMIN** can PATCH. When locked, request body must include `reason` (string); reason is stored in audit `detailsJson`.

---

## TASK 4: UI

- **Page:** `/executive/insights` — `app/(dashboard)/executive/insights/ExecutiveInsightsClient.tsx`
- **Section:** “Employee Intelligence”
  - Table: Name, Sales MTD, Target, Ach%, Trend, Consistency, ERS, Label
  - Top 3 rows: highlight (emerald). Bottom 2: highlight (amber).
  - Expand/click to show ERS reasons (i18n keys from `executive.ers.*`).
- **i18n:** `messages/en.json`, `messages/ar.json` — `executive.ers.*`, `executive.employeeIntelligence.*`

---

## Summary

| Task | Status | Notes |
|------|--------|--------|
| 1 – Discovery | Done | BoutiqueMonthlyTarget, EmployeeMonthlyTarget, SalesEntry documented above |
| 2 – Employee Intelligence API | Done | GET `/api/executive/employee-intelligence`, ERS in metrics.ts |
| 3 – Governance | Done | SalesTargetAudit reused; day-3 lock in employee-target PATCH |
| 4 – UI | Done | Employee Intelligence table on /executive/insights with expandable reasons |

No Prisma migration required for v1.2; all uses existing models.
